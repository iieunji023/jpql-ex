## ê²½ë¡œ í‘œí˜„ì‹

- .(ì )ì„ ì°ì–´ ê°ì²´ ê·¸ë˜í”„ë¥¼ íƒìƒ‰í•˜ëŠ” ê²ƒ

```
select **m.username**  // ìƒíƒœ í•„ë“œ
from Member m
join **m.team** t  // ë‹¨ì¼ ê°’ ì—°ê´€ í•„ë“œ
join **m.orders** o  // ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ í•„ë“œ
where t.name = 'íŒ€A'
```

### ê²½ë¡œ í‘œí˜„ì‹ ìš©ì–´ ì •ë¦¬

- ìƒíƒœ í•„ë“œ(state field)
    - ë‹¨ìˆœíˆ ê°’ì„ ì €ì¥í•˜ê¸° ìœ„í•œ í•„ë“œ(ex. m.username)
- ì—°ê´€ í•„ë“œ(association field)
    - ì—°ê´€ê´€ê³„ë¥¼ ìœ„í•œ í•„ë“œ
    1. ë‹¨ì¼ ê°’ ì—°ê´€ í•„ë“œ
        - `@ManyToOne`, `@OneToOne`, ëŒ€ìƒì´ ì—”í‹°í‹°(ex. m.team)
    2. ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ í•„ë“œ
        - `@OneToMany`, `@ManyToMany`, ëŒ€ìƒì´ ì»¬ë ‰ì…˜(ex. m.orders)

### ê²½ë¡œ í‘œí˜„ì‹ íŠ¹ì§•

> ìƒíƒœ í•„ë“œ(state field)
<br> - ê²½ë¡œ íƒìƒ‰ì˜ ë, íƒìƒ‰ X

```
select m.username From Member m
```

> ë‹¨ì¼ ê°’ ì—°ê´€ ê²½ë¡œ
<br> - ë¬µì‹œì  ë‚´ë¶€ ì¡°ì¸(inner join) ë°œìƒ, íƒìƒ‰ O

- ë¬µì‹œì  ë‚´ë¶€ ì¡°ì¸ â­

    ```
    // ì¿¼ë¦¬ë¬¸
    select m.team From Member m
    
    // ì¶œë ¥ê²°ê³¼
    Hibernate: 
        /* select
            m.team 
        From
            Member m */ select
                t1_0.id,
                t1_0.name 
            from
                Member m1_0 
            join
                Team t1_0 
                    on t1_0.id=m1_0.TEAM_ID
    ```

    - selectë¬¸ìœ¼ë¡œ ì‘ì„±í–ˆì§€ë§Œ ë‚´ë¶€ ì¡°ì¸ ë°œìƒ
- ê³„ì† íƒìƒ‰í•  ìˆ˜ ìˆë‹¤. (team ë‚´ì˜ í•„ë“œ ì¡°íšŒ)

    ```
    select m.team.name From Member m
    ```


> ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œ
<br> - ë¬µì‹œì  ë‚´ë¶€ ì¡°ì¸ ë°œìƒ, íƒìƒ‰X

```
select t.members From Team t
```

- ì»¬ë ‰ì…˜ ìì²´ë¥¼ ê°€ë¦¬í‚¤ê¸° ë•Œë¬¸ì— í•„ë“œë¥¼ ì°ëŠ” ë“± ë”ì´ìƒ íƒìƒ‰ì€ í•  ìˆ˜ ì—†ìŒ!
  (members ë‚´ì˜ username íƒìƒ‰ ë¶ˆê°€)

```
select m.username From Team t join t.members m
```

- Fromì ˆì—ì„œ ëª…ì‹œì  ì¡°ì¸ì„ í†µí•´ ë³„ì¹­ì„ ì–»ìœ¼ë©´ ë³„ì¹­ì„ í†µí•´ íƒìƒ‰ ê°€ëŠ¥

  (ëª…ì‹œì  ì¡°ì¸ì„ ì¨ì•¼ ì¿¼ë¦¬ íŠœë‹ ë“± ìœ ì§€ë³´ìˆ˜ ì¸¡ë©´ì—ì„œ ì¢‹ìŒ)


### ìƒíƒœ í•„ë“œ ê²½ë¡œ íƒìƒ‰

- JPQL

    ```
    select m.username, m.age from Member m
    ```

- SQL

    ```
    select m.username, m.age from Member m
    ```


### ë‹¨ì¼ ê°’ ì—°ê´€ ê²½ë¡œ íƒìƒ‰

- JPQL

    ```
    select o.member from Order o
    ```

- SQL

    ```
    select m.* from Order o inner join Member m on o.member_id = m.id
    ```


### ëª…ì‹œì  ì¡°ì¸, ë¬µì‹œì  ì¡°ì¸

- ëª…ì‹œì  ì¡°ì¸

    ```
    select m from Member m join m.team t
    ```

    - join í‚¤ì›Œë“œ ì§ì ‘ ì‚¬ìš©
- ë¬µì‹œì  ì¡°ì¸

    ```
    select m.team from Member m
    ```

    - ê²½ë¡œ í‘œí˜„ì‹ì— ì˜í•´ ë¬µì‹œì ìœ¼ë¡œ SQL ì¡°ì¸ ë°œìƒ
      (ë‚´ë¶€ ì¡°ì¸ë§Œ ê°€ëŠ¥)

### ê²½ë¡œ íƒìƒ‰ì„ ì‚¬ìš©í•œ ë¬µì‹œì  ì¡°ì¸ ì‹œ ì£¼ì˜ì‚¬í•­

- í•­ìƒ ë‚´ë¶€ ì¡°ì¸
- ì»¬ë ‰ì…˜ì€ ê²½ë¡œ íƒìƒ‰ì˜ ë, ëª…ì‹œì  ì¡°ì¸ì„ í†µí•´ ë³„ì¹­ì„ ì–»ì–´ì•¼ í•¨
- ê²½ë¡œ íƒìƒ‰ì€ ì£¼ë¡œ SELECT, WHEREì ˆì—ì„œ ì‚¬ìš©í•˜ì§€ë§Œ ë¬µì‹œì  ì¡°ì¸ìœ¼ë¡œ ì¸í•´ SQLì˜ FROM (JOIN) ì ˆì— ì˜í–¥ì„ ì¤Œ
- **ê°€ê¸‰ì  ë¬µì‹œì  ì¡°ì¸ ëŒ€ì‹  ëª…ì‹œì  ì¡°ì¸ ì‚¬ìš©**
- ì¡°ì¸ì€ SQL íŠœë‹ì— ì¤‘ìš” í¬ì¸íŠ¸
- ë¬µì‹œì  ì¡°ì¸ì€ ì¡°ì¸ì´ ì¼ì–´ë‚˜ëŠ” ìƒí™©ì„ í•œëˆˆì— íŒŒì•…í•˜ê¸° ì–´ë ¤ì›€

<br>

## í˜ì¹˜ ì¡°ì¸ 1 - ê¸°ë³¸

ì¡°íšŒí•  ë•Œ ë§ì´ ì‚¬ìš©

ì‹¤ë¬´ì—ì„œ ì¤‘ìš”!!

- SQL ì¡°ì¸ ì¢…ë¥˜ X
- JPQLì—ì„œ **ì„±ëŠ¥ ìµœì í™”**ë¥¼ ìœ„í•´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥
- ì—°ê´€ëœ ì—”í‹°í‹°ë‚˜ ì»¬ë ‰ì…˜ì„ **SQL í•œë²ˆì— í•¨ê»˜ ì¡°íšŒ**í•˜ëŠ” ê¸°ëŠ¥
- join fetch ëª…ë ¹ì–´ ì‚¬ìš©
- í˜ì¹˜ ì¡°ì¸ ::=[LEFT [OUTER] | INNER ] JOIN FETCH ì¡°ì¸ê²½ë¡œ

### ì—”í‹°í‹° í˜ì¹˜ ì¡°ì¸

- íšŒì›ì„ ì¡°íšŒí•˜ë©´ì„œ ì—°ê´€ëœ íŒ€ë„ í•¨ê»˜ ì¡°íšŒ(SQL í•œë²ˆì—)
- SQLì„ ë³´ë©´ íšŒì› ë¿ë§Œ ì•„ë‹ˆë¼ **íŒ€(T.*)**ë„ í•¨ê»˜ **SELECT**
- [JPQL]
  select m from Member m **join fetch** m.team
- [SQL]
  SELECT M.*, **T.*** FROM MEMBER M **INNER JOIN TEAM** T ON M.TEAM_ID=T.ID
- **ì¦‰ì‹œë¡œë”©**ìœ¼ë¡œ ê°€ì ¸ì˜¬ ë•Œì™€ ë™ì¼

<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/í˜ì¹˜ì¡°ì¸1.png" width="450"><br>
<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/í˜ì¹˜ì¡°ì¸2.png" width="300">

### ì‹¤ìŠµ

ğŸ”§ Member ì¡°íšŒ(í˜ì¹˜ì¡°ì¸ ì‚¬ìš© X)

<details>
      <summary>main.java</summary>

```
Team teamA = new Team();
teamA.setName("íŒ€A");
em.persist(teamA);

Team teamB = new Team();
teamB.setName("íŒ€B");
em.persist(teamB);

Member member1 = new Member();
member1.setUsername("íšŒì›1");
member1.setTeam(teamA);
em.persist(member1);

Member member2 = new Member();
member2.setUsername("íšŒì›2");
member2.setTeam(teamA);
em.persist(member2);

Member member3 = new Member();
member3.setUsername("íšŒì›3");
member3.setTeam(teamB);
em.persist(member3);

em.flush();
em.clear();

String query = "select m From Member m";
List<Member> result = em.createQuery(query, Member.class).getResultList();

for (Member member : result) {
     System.out.println("member= " + member.getUsername() + ", " + member.getTeam().getName());
     // íšŒì›1, íŒ€A(SQL)
     // íšŒì›2, íŒ€A(1ì°¨ìºì‹œ)
     // íšŒì›3, íŒ€B
}
            
tx.commit();
```

</details>
<details>
      <summary>ì¿¼ë¦¬ ì¡°íšŒ ê²°ê³¼</summary>

```
    /* select
        m 
    From
        Member m 
    join
        
    fetch
        m.team */ select
            m1_0.id,
            m1_0.age,
            t1_0.id,
            t1_0.name,
            m1_0.type,
            m1_0.username 
        from
            Member m1_0 
        join
            Team t1_0 
                on t1_0.id=m1_0.TEAM_ID
member= íšŒì›1, íŒ€A
member= íšŒì›2, íŒ€A
member= íšŒì›3, íŒ€B
```

- í˜ì¹˜ì¡°ì¸ìœ¼ë¡œ íšŒì›ê³¼ íŒ€ì„ í•¨ê»˜ ì¡°íšŒí•´ì„œ ì§€ì—°ë¡œë”©X
- JOINí•  ë•Œ memberì™€ team í…Œì´ë¸” ë‚´ì˜ ì»¬ëŸ¼ì„ ëª¨ë‘ ì¡°íšŒí•˜ë¯€ë¡œ selectë¬¸ í•œë²ˆë§Œ ë‚ ë¼ê°
- ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¸íŒ…í•´ë„ í˜ì¹˜ì¡°ì¸ì´ í•­ìƒ ìš°ì„ 

</details>

ğŸ’¡ ì¼ëŒ€ë‹¤ ê´€ê³„ì—ì„œ, ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì„ ì‹¤í–‰í•´ë³´ì

- **[JPQL]** <br>
  select t from Team t join fetch t.members
  where t.name = â€˜íŒ€Aâ€™
- **[SQL]** <br>
  SELECT T.*, M.* FROM TEAMT
  INNER JOIN MEMBER M ON T.ID=M.TEAM_ID
  WHERE T.NAME=â€™íŒ€Aâ€™

<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/í˜ì¹˜ì¡°ì¸3.png" width="500">

ğŸ”§ ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ ì½”ë“œ
```
String query = "select t From Team t join fetch t.members";
List<Team> result = em.createQuery(query, Team.class).getResultList();

for (Team team : result) {
     System.out.println("team= " + team.getName() + " |members= " + team.getMembers().size());
     for(Member member : team.getMembers()) {
          System.out.println("-> member = " + member);
     }
}
```
ğŸ”— ì¶œë ¥ê²°ê³¼
```
team= íŒ€A |members= 2
-> member = Member{id=1, username='íšŒì›1', age=0}
-> member = Member{id=2, username='íšŒì›2', age=0}
team= íŒ€B |members= 1
-> member = Member{id=3, username='íšŒì›3', age=0}
```
- ì¼ëŒ€ë‹¤ ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì„ í•˜ë©´ íŒ€AëŠ” í•˜ë‚˜ì§€ë§Œ, íŒ€Aì— ì†Œì†ëœ íšŒì›ì´ 2ëª…ì´ë¯€ë¡œ sizeê°€ ì¦ê°€í•œë‹¤.

### í˜ì¹˜ ì¡°ì¸ê³¼ ì¼ë°˜ ì¡°ì¸ì˜ ì°¨ì´

- ì¼ë°˜ ì¡°ì¸ ì‹¤í–‰ì‹œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ì§€ ì•ŠìŒ
```
select t From Team t join t.members m
```

ğŸ”— ì¶œë ¥ê²°ê³¼
```
Hibernate: 
    select
        m1_0.TEAM_ID,
        m1_0.id,
        m1_0.age,
        m1_0.type,
        m1_0.username 
    from
        Member m1_0 
    where
        m1_0.TEAM_ID=?
team= íŒ€A |members= 2
-> member = Member{id=1, username='íšŒì›1', age=0}
-> member = Member{id=2, username='íšŒì›2', age=0}
Hibernate: 
    select
        m1_0.TEAM_ID,
        m1_0.id,
        m1_0.age,
        m1_0.type,
        m1_0.username 
    from
        Member m1_0 
    where
        m1_0.TEAM_ID=?
team= íŒ€B |members= 1
-> member = Member{id=3, username='íšŒì›3', age=0}
```
- ì¼ë°˜ ì¡°ì¸ì„ í•˜ë©´, ê° í…Œì´ë¸”ì— ëŒ€í•œ selectë¬¸ì´ ë³„ë„ë¡œ ìƒì„±ëœë‹¤.

```
Hibernate: 
    /* select
        t 
    From
        Team t 
    join
        
    fetch
        t.members */ select
            t1_0.id,
            m1_0.TEAM_ID,
            m1_0.id,
            m1_0.age,
            m1_0.type,
            m1_0.username,
            t1_0.name 
        from
            Team t1_0 
        join
            Member m1_0 
                on t1_0.id=m1_0.TEAM_ID
team= íŒ€A |members= 2
-> member = Member{id=1, username='íšŒì›1', age=0}
-> member = Member{id=2, username='íšŒì›2', age=0}
team= íŒ€B |members= 1
-> member = Member{id=3, username='íšŒì›3', age=0}
```
- í˜ì¹˜ ì¡°ì¸ì„ í•˜ê²Œ ë˜ë©´ í•˜ë‚˜ì˜ selectë¬¸ì— member, team í…Œì´ë¸”ì˜ ì»¬ëŸ¼ì„ ëª¨ë‘ ì¡°íšŒí•œë‹¤.

ë”°ë¼ì„œ, í˜ì¹˜ ì¡°ì¸ê³¼ ì¼ë°˜ ì¡°ì¸ì˜ ì°¨ì´ëŠ”

- JPQLì€ ê²°ê³¼ë¥¼ ë°˜í™˜í•  ë•Œ ì—°ê´€ê´€ê³„ ê³ ë ¤X
- ë‹¨ì§€ SELECTì ˆì— ì§€ì •í•œ ì—”í‹°í‹°ë§Œ ì¡°íšŒí•  ë¿
- ì—¬ê¸°ì„œëŠ” íŒ€ ì—”í‹°í‹°ë§Œ ì¡°íšŒí•˜ê³ , íšŒì› ì—”í‹°í‹°ëŠ” ì¡°íšŒX
- í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•  ë•Œë§Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ **ì¡°íšŒ(ì¦‰ì‹œ ë¡œë”©)**
- **í˜ì¹˜ ì¡°ì¸ì€ ê°ì²´ ê·¸ë˜í”„ë¥¼ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ê°œë…**

<br>

## íŒ¨ì¹˜ ì¡°ì¸ 2 - í•œê³„

### í˜ì¹˜ ì¡°ì¸ì˜ íŠ¹ì§•ê³¼ í•œê³„

- í˜ì¹˜ ì¡°ì¸ ëŒ€ìƒì—ëŠ” ë³„ì¹­ì„ ì¤„ ìˆ˜ ì—†ë‹¤.

  í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ê°€ëŠ¥, ê°€ê¸‰ì  ì‚¬ìš© X

    ```
    select t From Team t join fetch t.members as m
    ```

    ```
    select t From Team t join fetch t.members m join fetch m.team
    ```

- ë‘˜ ì´ìƒì˜ ì»¬ë ‰ì…˜ì€ í˜ì¹˜ ì¡°ì¸ í•  ìˆ˜ ì—†ë‹¤.
- ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ì¡°ì¸í•˜ë©´ í˜ì´ì§• API(setFirstResult, setMaxResults)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
  - ì¼ëŒ€ì¼, ë‹¤ëŒ€ì¼ ê°™ì€ ë‹¨ì¼ ê°’ ì—°ê´€ í•„ë“œë“¤ì€ í˜ì¹˜ ì¡°ì¸í•´ë„ í˜ì´ì§• ê°€ëŠ¥
  - í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ê²½ê³  ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§•(ë§¤ìš° ìœ„í—˜)

```
ğŸ’¡ ë§Œì•½ Team 10ê°œë©´ Teamê³¼ ê´€ë ¨ëœ Memberë¥¼ ì°¾ê¸° ìœ„í•´ Teamì¿¼ë¦¬ 1ê°œ + lazyë¡œë”©ìœ¼ë¡œ ì¸í•œ member ì¿¼ë¦¬ 10ê°œ, ì´ ì¿¼ë¦¬ë¬¸ì´ 11ê°œ ëŒì•„ê°€ì•¼ í•œë‹¤. ì´ë¥¼ í•´ê²°í•  ë•Œ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ëŠ”ë°, ì»¬ë ‰ì…˜ì¸ ê²½ìš°(ì¼ëŒ€ë‹¤, â€¦.) í•´ê²°ì´ ì•ˆë¨..!ğŸ˜‚ì´ë•Œ, @BatchSize()ë¥¼ ì‚¬ìš©

```

```
ğŸ”— Batch Size() ì‚¬ìš©

1. ì—”í‹°í‹°ì—ì„œ ì…‹íŒ…

    ```
    @BatchSize(size=100)
    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList<>();
    ```

2. ê¸€ë¡œë²Œ ì…‹íŒ…
  - persistence.xml

    ```
    <property name="hibernate.default_batch_fetch_size" value="100"/>
    ```

```

- ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆìœ¼ë¡œ ì¡°íšŒ - ì„±ëŠ¥ ìµœì í™”
- ì—”í‹°í‹°ì— ì§ì ‘ ì ìš©í•˜ëŠ” ê¸€ë¡œë²Œ ë¡œë”© ì „ëµë³´ë‹¤ ìš°ì„ í•¨
  - `OneToMany(fetch=FetchType.LAZY)  // ê¸€ë¡œë²Œ ë¡œë”© ì „ëµ`
- ì‹¤ë¬´ì—ì„œ ê¸€ë¡œë²Œ ë¡œë”© ì „ëµì€ ëª¨ë‘ ì§€ì—° ë¡œë”©
- ìµœì í™”ê°€ í•„ìš”í•œ ê³³ì€ í˜ì¹˜ ì¡°ì¸ ì ìš©

### ì •ë¦¬

- ëª¨ë“  ê²ƒì„ í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ëŠ” ì—†ìŒ
- í˜ì¹˜ ì¡°ì¸ì€ ê°ì²´ ê·¸ë˜í”„ë¥¼ ìœ ì§€í•  ë•Œ ì‚¬ìš©í•˜ë©´ íš¨ê³¼ì 
- ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì„œ ì—”í‹°í‹°ê°€ ê°€ì§„ ëª¨ì–‘ì´ ì•„ë‹Œ ì „í˜€ ë‹¤ë¥¸ ê²°ê³¼ë¥¼ ë‚´ì•¼ í•˜ë©´, í˜ì¹˜ ì¡°ì¸ë³´ë‹¤ëŠ” ì¼ë°˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ê³  í•„ìš”í•œ ë°ì´í„°ë“¤ë§Œ ì¡°íšŒí•´ì„œ DTOë¡œ ë°˜í™˜í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì 

1. í˜ì¹˜ì¡°ì¸ì„ ì‚¬ìš©í•´ì„œ ì—”í‹°í‹° ì¡°íšŒ
2. í˜ì¹˜ì¡°ì¸ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DTOë¡œ ë°˜í™˜í•œ í›„ ì¡°íšŒ
3. jpql ì²˜ìŒë¶€í„° new operation?ìœ¼ë¡œ DTOë¥¼ ê°€ì ¸ì˜¨ë‹¤

<br>

## ë‹¤í˜•ì„± ì¿¼ë¦¬

<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/ë‹¤í˜•ì„±ì¿¼ë¦¬.png" width="300">

### Type

- ì¡°íšŒ ëŒ€ìƒì„ íŠ¹ì • ìì‹ìœ¼ë¡œ í•œì •
- ex) Item ì¤‘ì— Book, Movieë¥¼ ì¡°íšŒí•´ë¼
- **[JPQL]**
  select i from item i where type(i) IN (Book, Movie)
- **[SQL]**
  select i from i where i.DTYPE in (â€™Bâ€™, â€˜Mâ€™)

### TREAT(JPA2.1)

- ìë°”ì˜ íƒ€ì… ìºìŠ¤íŒ…ê³¼ ìœ ì‚¬
- ë‹¤ìš´ìºìŠ¤íŒ…
- ìƒì† êµ¬ì¡°ì—ì„œ ë¶€ëª¨ íƒ€ì…ì„ íŠ¹ì • ìì‹ íƒ€ì…ìœ¼ë¡œ ë‹¤ë£° ë•Œ ì‚¬ìš©
- FROM, WHERE, SELECT(í•˜ì´ë²„ë„¤ì´íŠ¸ ì§€ì›) ì‚¬ìš©
- ex) ë¶€ëª¨ì¸ Itemê³¼ ìì‹ Bookì´ ìˆë‹¤
- **[JPQL]**
  select i from item i where treat(i as Book).author = â€˜kimâ€™
- **[SQL]**
  select i from i where i.DTYPE = â€˜Bâ€™ and i.author = â€˜kimâ€™

<br>

## ì—”í‹°í‹° ì§ì ‘ ì‚¬ìš©

### ê¸°ë³¸ í‚¤ ê°’

- JPQLì—ì„œ ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ë©´ SQLì—ì„œ í•´ë‹¹ ì—”í‹°í‹°ì˜ ê¸°ë³¸ í‚¤ ê°’ì„ ì‚¬ìš©
- **[JPQL]**
  select count(m.id) from Member m  // ì—”í‹°í‹°ì˜ ì•„ì´ë””ë¥¼ ì‚¬ìš©
  select count(m) from Member m  // ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì‚¬ìš©
- **[SQL]**(JPQL ë‘˜ë‹¤ ê°™ì€ ë‹¤ìŒ SQL ì‹¤í–‰)
  select count(m.id) as cnt from Member m

```

String query = "select m From Member m where m = :member";
Member findMember = em.createQuery(query, Member.class).setParameter("member", member1).getSingleResult();

```

```
Hibernate: 
    /* select
        m 
    From
        Member m 
    where
        m = :member */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.type,
            m1_0.username 
        from
            Member m1_0 
        where
            m1_0.id=?
```

- ì—”í‹°í‹° ìì²´ë¥¼ ë„˜ê²¼ì§€ë§Œ ì¿¼ë¦¬ë¬¸ì„ ë³´ë©´ m_idë¡œ ë°”ë€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤

```
String query = "select m From Member m where m.id = :memberId";
Member findMember = em.createQuery(query, Member.class).setParameter("memberId", member1.getId()).getSingleResult();

```

- ì—”í‹°í‹°ì˜ ì•„ì´ë””ë¡œ ì‹¤í–‰í•´ë„ ì¿¼ë¦¬ë¬¸ì€ ë™ì¼

### ì™¸ë˜ í‚¤ ê°’

> ì—”í‹°í‹° ì‚¬ìš©

```
String query = "select m From Member m where m.team = :team";
Member findMember = em.createQuery(query, Member.class).setParameter("team", teamB).getSingleResult();
```

> ì¿¼ë¦¬ë¬¸ ê²°ê³¼

```
Hibernate: 
    /* select
        m 
    From
        Member m 
    where
        m.team = :team */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.type,
            m1_0.username 
        from
            Member m1_0 
        where
            m1_0.TEAM_ID=?

```

<br>

## Named ì¿¼ë¦¬

- ë¯¸ë¦¬ ì •ì˜í•´ì„œ ì´ë¦„ì„ ë¶€ì—¬í•´ë‘ê³  ì‚¬ìš©í•˜ëŠ” JPQL
- ì •ì  ì¿¼ë¦¬
- ì–´ë…¸í…Œì´ì…˜, XMLì— ì •ì˜
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì´ˆê¸°í™” í›„ ì¬ì‚¬ìš©
  - JPQLì€ SQLë¡œ íŒŒì‹±ë¼ì„œ ì‹¤í–‰
  - í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ë¡œë”©ì‹œì ì— ì´ˆê¸°í™”
- **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì¿¼ë¦¬ë¥¼ ê²€ì¦**

ğŸ”— Member ì—”í‹°í‹°

```
@Entity
@NamedQuery(
        name = "Member.findByUsername",
        query = "select m from Member m where m.username = :username"
)
public class Member {}
```

- ë„¤ì„ë“œ ì¿¼ë¦¬ëª…ê³¼ ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±

ğŸ”— Main

```
List<Member> resultList = em.createNamedQuery("Member.findByUsername", Member.class)
                    .setParameter("username", "íšŒì›1")
                    .getResultList();

for (Member member : resultList) {
       System.out.println("member = " + member);
}
```

- named ì¿¼ë¦¬ëª…ìœ¼ë¡œ ì¿¼ë¦¬ ì‘ì„± ê°€ëŠ¥
- ë„¤ì„ë“œ ì¿¼ë¦¬ë¥¼ ì˜ëª» ì‘ì„±í–ˆë”ë¼ë„ ì»´íŒŒì¼ ì‹œì ì—ì„œ ì¡ì„ ìˆ˜ ìˆë‹¤
- ì‹¤ë¬´ì—ì„œëŠ” `@NamedQuery`ë³´ë‹¤ëŠ” ë ˆíŒŒì§€í† ë¦¬ì—ì„œ `@Query`ë¡œ ì‘ì„±í•¨!

```
Hibernate: 
    /* select
        m 
    from
        Member m 
    where
        m.username = :username */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.type,
            m1_0.username 
        from
            Member m1_0 
        where
            m1_0.username=?
member = Member{id=1, username='íšŒì›1', age=0}
```

### Named ì¿¼ë¦¬ í™˜ê²½ì— ë”°ë¥¸  ì„¤ì •

- XMLì´ í•­ìƒ ìš°ì„ ê¶Œì„ ê°€ì§„ë‹¤.
- ì• í”Œë¦¬ì¼€ì´ì…˜ ìš´ì˜ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¸ XMLì„ ë°°í¬í•  ìˆ˜ ìˆë‹¤.

<br>

## ë²Œí¬ ì—°ì‚°

- SQLì˜ update, deleteë¬¸

```
ğŸ’¡ ì˜ˆì‹œ ìƒí™©

- ì¬ê³ ê°€ 10ê°œ ë¯¸ë§Œì¸ ëª¨ë“  ìƒí’ˆì˜ ê°€ê²©ì„ 10% ìƒìŠ¹í•˜ë ¤ë©´?
- JPA ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´ ë„ˆë¬´ ë§ì€ SQL ì‹¤í–‰

  1. ì¬ê³ ê°€ 10ê°œ ë¯¸ë§Œì¸ ìƒí’ˆì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì¡°íšŒí•œë‹¤.
  2. ìƒí’ˆ ì—”í‹°í‹°ì˜ ê°€ê²©ì„ 10% ì¦ê°€í•œë‹¤.
  3. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ê°ì§€ê°€ ë™ì‘í•œë‹¤.

- ë³€ê²½ëœ ë°ì´í„°ê°€ 100ê±´ì´ë¼ë©´ 100ë²ˆì˜ UPDATE SQL ì‹¤í–‰
```

### ì˜ˆì œ

- ì¿¼ë¦¬ í•œë²ˆìœ¼ë¡œ ì—¬ëŸ¬ í…Œì´ë¸” ë¡œìš° ë³€ê²½(ì—”í‹°í‹°)
- executeUpdate()ì˜ ê²°ê³¼ëŠ” ì˜í–¥ë°›ì€ ì—”í‹°í‹° ìˆ˜ ë°˜í™˜
- UPDATE, DELETE ì§€ì›
- INSERT(insert into .. select, í•˜ì´ë²„ë„¤ì´íŠ¸ ì§€ì›)

```
// ëª¨ë“  íšŒì›ì˜ ë‚˜ì´ë¥¼ 20ì‚´ë¡œ ë³€ê²½
int resultCount = em.createQuery("update Member m set m.age = 20").executeUpdate();
System.out.println("resultCount = " + resultCount);

// ì¶œë ¥ê²°ê³¼
resultCount = 3
```

### ë²Œí¬ì—°ì‚° ì£¼ì˜

- ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì¿¼ë¦¬
- EX)
  - ì—”í‹°í‹° ë‚´ì˜ íšŒì› ì—°ë´‰ì€ 5000ë§Œì›ì´ë¼ ê°€ì •í•˜ì. ë²Œí¬ ì—°ì‚°ìœ¼ë¡œ DBì— ì—°ë´‰ì„ 6000ìœ¼ë¡œ UPDATEë¥¼ ì‹œì¼œì¤¬ë‹¤.
  - ì´ëŸ¬í•œ ê²½ìš° DBì—ëŠ” ì—°ë´‰ì´ 6000ì´ì§€ë§Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” 5000ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆì–´ì„œ ë°ì´í„° ì •í•©ì„±ì´ ë§ì§€ ì•Šì„ ìœ„í—˜ì´ ìˆë‹¤.

ğŸ”§ í•´ê²°ë°©ë²•

- ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ìˆ˜í–‰
- ë²Œí¬ ì—°ì‚° ìˆ˜í–‰ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”

ğŸ’¡ ì˜ˆì œë¥¼ í†µí•´ ì•Œì•„ë³´ì. (íšŒì› ë‚˜ì´ë¥¼ 20ì‚´ë¡œ UPDATE)

```
// FLUSH ìë™ í˜¸ì¶œ
int resultCount = em.createQuery("update Member m set m.age = 20").executeUpdate();
System.out.println("resultCount = " + resultCount);

System.out.println("member1 = " + member1.getAge());
System.out.println("member2 = " + member2.getAge());
System.out.println("member3 = " + member3.getAge());
```

```
resultCount = 3
member1 = 0
member2 = 0
member3 = 0
```

- ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ageê°€ ì´ˆê¸°ê°’ 0ìœ¼ë¡œ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸
- ì´ˆê¸°ì— `em.persist()`ì— ì €ì¥ë˜ì–´ ìˆëŠ” ê°’ì€ 0
- `executeUpdate()`ë¥¼ í–ˆë‹¤ê³  í•´ì„œ ì˜ì†ì„±ì— ì €ì¥ë˜ì–´ ìˆëŠ” ê°’ì€ ë³€í•˜ì§€ ì•ŠìŒ

<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/ë²Œí¬ì—°ì‚°.png" width="300">

- `executeUpdate()`ë¥¼ í†µí•´ DB ì—…ë°ì´íŠ¸
- DBì—ì„œëŠ” íšŒì› ëª¨ë‘ 20ì‚´ë¡œ updateëœ ê²ƒì„ í™•ì¸

**ğŸ”— ë²Œí¬ ì—°ì‚° ìˆ˜í–‰ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” í•´ì£¼ê¸°**

```
// ë²Œí¬ ì—°ì‚° ìˆ˜í–‰
int resultCount = em.createQuery("update Member m set m.age = 20").executeUpdate();
// ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
em.clear();
// Member ì¡°íšŒ
Member findMember = em.find(Member.class, member1.getId());
System.out.println("findMember.getAge() = " + findMember.getAge());

// ì¶œë ¥ê²°ê³¼
findMember.getAge() = 20
```

- `em.clear()`ë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê³  Memberë¥¼ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•œë‹¤.