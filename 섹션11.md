## ê¸°ë³¸ ë¬¸ë²•ê³¼ ì¿¼ë¦¬ API

### ì—”í‹°í‹° ìƒì„±
<details>
      <summary>Member.java</summary>

```
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    private String username;

    private int age;

    @ManyToOne
    @JoinColumn(name="TEAM_ID")
    private Team team;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }
}
```

</details>
<details>
      <summary>Team.java</summary>

```
@Entity
public class Team {
    @Id @GeneratedValue
    private Long id;

    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList<>();

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}

```

</details>
<details>
      <summary>Order.java</summary>

```
@Entity
@Table(name="ORDERS")
public class Order {
    @Id @GeneratedValue
    private Long id;

    private int orderAmount;

    @Embedded
    private Address address;

    @ManyToOne
    @JoinColumn(name="PRODUCT_ID")
    private Product product;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public int getOrderAmount() {
        return orderAmount;
    }

    public void setOrderAmount(int orderAmount) {
        this.orderAmount = orderAmount;
    }

    public Address getAddress() {
        return address;
    }

    public void setAddress(Address address) {
        this.address = address;
    }

    public Product getProduct() {
        return product;
    }

    public void setProduct(Product product) {
        this.product = product;
    }
}

```

</details>
<details>
      <summary>Address.java</summary>

- ê°’ íƒ€ì…

```
@Embeddable
public class Address {
    private String city;

    private String street;

    private String zipcode;

    public String getCity() {
        return city;
    }

    public void setCity(String city) {
        this.city = city;
    }

    public String getStreet() {
        return street;
    }

    public void setStreet(String street) {
        this.street = street;
    }

    public String getZipcode() {
        return zipcode;
    }

    public void setZipcode(String zipcode) {
        this.zipcode = zipcode;
    }
}

```

</details>

<details>
      <summary>âš ï¸ í…Œì´ë¸” ìƒì„± ì¤‘ ì—ëŸ¬ ë°œìƒ</summary>

```
10:21:14.384 [main] WARN org.hibernate.tool.schema.internal.ExceptionHandlerLoggedImpl -- GenerationTarget encountered exception accepting command : Error executing DDL "
```

- ì›ì¸: Order í…Œì´ë¸”ì´ ì˜ˆì•½ì–´ì´ë¯€ë¡œ, ë”°ë¡œ í…Œì´ë¸”ëª… ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤
- í•´ê²°ë°©ë²•

    ```
    @Entity
    @Table(name="ORDERS")
    public class Order {}
    ```

    - ORDER â†’ ORDERSë¡œ ë³€ê²½í•´ì£¼ë‹ˆ í•´ê²°ë¨

</details>

### JPQL ë¬¸ë²•

- select m from Member as m where m.age > 18
- ì—”í‹°í‹°ì™€ ì†ì„±ì€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„O(Member, age)
    - ê°€ì§€ê³  ìˆëŠ” ê°ì²´ì™€ ë™ì¼í•˜ê²Œ ì‘ì„±í•´ì•¼ í•¨
- JPQL í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„X(SELECT, FROM, where)
- ì—”í‹°í‹° ì´ë¦„ ì‚¬ìš©, í…Œì´ë¸” ì´ë¦„ ì•„ë‹˜(Member)
- ë³„ì¹­ì€ í•„ìˆ˜(m) (asëŠ” ìƒëµ ê°€ëŠ¥)

### ì§‘í•©ê³¼ ì •ë ¬

```
select
  COUNT**(m),  // íšŒì›ìˆ˜**
  SUM**(m.age),  // ë‚˜ì´ í•©**
  AVG**(m.age)  // í‰ê·  ë‚˜ì´**
  MAX**(m.age)  // ìµœëŒ€ ë‚˜ì´**
  MIN**(m.age) // ìµœì†Œ ë‚˜ì´**
from Member m
```

- GROUP BY, HAVING
- ORDER BY

### TypeQuery, Query

- TypeQuery: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•  ë•Œ ì‚¬ìš©
- Query: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©

```
TypedQuery<Member> query = em.createQuery("select m from Member m", Member.class);
TypedQuery<String> query = em.createQuery("select m.username, m.age from Member m", String.class);
Query query = em.createQuery("select m.username, m.age from Member m");
```

- Member ê°ì²´ ì „ì²´ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜, `m.username`ê³¼ ê°™ì´ String íƒ€ì…ë§Œì„ ì¡°íšŒí•  ë•ŒëŠ” `TypedQuery` ì‚¬ìš©
- ê·¸ëŸ¬ë‚˜ `m.username`, `m.age` ë“± íƒ€ì…ì´ ë‹¤ë¥¸ í•„ë“œë¥¼ ì¡°íšŒí•  ë•ŒëŠ” `query`ë¥¼ ì‚¬ìš©

### ê²°ê³¼ ì¡°íšŒ API

- query.getResultList(): ê²°ê³¼ê°€ í•˜ë‚˜ ì´ìƒì¼ ë•Œ, ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    - ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
        - NullPointException ë°œìƒí•˜ì§€ ì•ŠìŒ!
  - query.getSingleResult(): ê²°ê³¼ê°€ ì •í™•íˆ í•˜ë‚˜, ë‹¨ì¼ ê°ì²´ ë°˜í™˜
      - ê²°ê³¼ê°€ ì—†ìœ¼ë©´  javax.persistence.NoResultException
      - ë‘˜ ì´ìƒì´ë©´ javax.persistence.NonUniqueResultException
      - ë”°ë¼ì„œ, ê°’ì´ ì •í™•íˆ í•˜ë‚˜ë§Œ ë°˜í™˜ë  ë•Œ ì‚¬ìš©í•´ì•¼ ë¨!!
      <details>
        <summary>ì˜ˆì‹œ</summary>

      ```
      TypedQuery<Member> query = em.createQuery("select m from Member m where m.id = 10", Member.class);
      Member result = query.getSingleResult();    // ê°’ì´ í•˜ë‚˜ë§Œ ë°˜í™˜ë˜ëŠ” ê²½ìš°, NullPoint Exception ë°œìƒ ìœ„í—˜
    
      tx.commit();
      ```
      ```
      jakarta.persistence.NoResultException: No result found for query [select m from Member m where m.id = 10]
	    at org.hibernate.query.spi.AbstractSelectionQuery.getSingleResult(AbstractSelectionQuery.java:567)
      ```
        
      - NoResultException ë°œìƒ
  
     </details>
    
### íŒŒë¼ë¯¸í„° ë°”ì¸ë”© - ì´ë¦„ ê¸°ì¤€, ìœ„ì¹˜ ê¸°ì¤€

> ì´ë¦„ ê¸°ì¤€

```
Member member = new Member();
member.setUsername("member1");
member.setAge(10);
em.persist(member);

Member result = em.createQuery("select m from Member m where m.username = :username", Member.class)
                   .setParameter("username", "member1")
                   .getSingleResult();

System.out.println("singleResult = " + result.getUsername());

tx.commit();
```

> ìœ„ì¹˜ ê¸°ì¤€

```
SELECT m FROM Member m where m.username=?1 
query.setParameter(1, usernameParam);
```

- ìœ„ì¹˜ ê¸°ì¤€ì€ ì‚¬ìš©XXX
- ì¤‘ê°„ì— ë‹¤ë¥¸ ê°’ì´ ë“¤ì–´ì˜¤ë©´ ê¼¬ì¼ ìœ„í—˜ ìˆìŒ

<br>

## í”„ë¡œì ì…˜(SELECT)

- SELECTì ˆì— ì¡°íšŒí•  ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒ
- í”„ë¡œì ì…˜ ëŒ€ìƒ: ì—”í‹°í‹°, ì„ë² ë””ë“œ íƒ€ì…, ìŠ¤ì¹¼ë¼ íƒ€ì…(ìˆ«ì, ë¬¸ì ë“± ê¸°ë³¸ ë°ì´í„° íƒ€ì…)
- `SELECT m FROM Member m` â†’ ì—”í‹°í‹° í”„ë¡œì ì…˜
- `SELECT m.team FROM Member m` â†’ ì—”í‹°í‹° í”„ë¡œì ì…˜

    ```
    em.createQuery("select m.team from Member m", Team.class).getResultList();
    ```

    - ì¿¼ë¦¬ íŠœë‹ ì¸¡ë©´ì—ì„œ ì¢‹ì§€ ì•ŠìŒ

    ```
    em.createQuery("select t from Member m join m.team t", Team.class).getResultList();
    ```

    - ì–´ë–¤ í…Œì´ë¸”ê³¼ joiní•˜ëŠ”ì§€ ëª…ì‹œí•´ì¤˜ì•¼ ìœ ì§€ë³´ìˆ˜í•  ë•Œ ì•Œì•„ë³´ê¸° ì‰½ë‹¤
- `SELECT m.address FROM Member m` â†’ ì„ë² ë””ë“œ íƒ€ì… í”„ë¡œì ì…˜

    ```
    em.createQuery("select o.address from Order o", Address.class).getResultList();
    ```

- `SELECT m.username, m.age FROM Member m` â†’ ìŠ¤ì¹¼ë¼ íƒ€ì… í”„ë¡œì ì…˜
- `DISTINCT`ë¡œ ì¤‘ë³µ ì œê±°

### í”„ë¡œì ì…˜ - ì—¬ëŸ¬ ê°’ ì¡°íšŒ

```
SELECT m.username, m.age FROM Member m
```

1. Query íƒ€ì…ìœ¼ë¡œ ì¡°íšŒ

    ```
    Member member = new Member();
    member.setUsername("member1");
    member.setAge(10);
    em.persist(member);
    
    em.flush();
    em.clear();
    
    List resultList = em.createQuery("select m.username, m.age from Member m").getResultList();
    
    Object o = resultList.get(0);
    Object[] result = (Object[]) o;
    
    System.out.println("username = " + result[0]);
    System.out.println("age = " + result[1]);
    
    tx.commit();
    ```

2. Object[] íƒ€ì…ìœ¼ë¡œ ì¡°íšŒ

    ```
    Member member = new Member();
    member.setUsername("member1");
    member.setAge(10);
    em.persist(member);
    
    em.flush();
    em.clear();
    
    List<Object[]> resultList = em.createQuery("select m.username, m.age from Member m").getResultList();
    
    Object[] result = resultList.get(0);
    
    System.out.println("username = " + result[0]);
    System.out.println("age = " + result[1]);
    
    tx.commit();
    ```

3. new ëª…ë ¹ì–´ë¡œ ì¡°íšŒ
    - ë‹¨ìˆœ ê°’ì„ DTOë¡œ ë°”ë¡œ ì¡°íšŒ
        - MemberDto ìƒì„±

            ```
            package jpql;
            
            public class MemberDTO {
                private String username;
                private int age;
            
                public MemberDTO(String username, int age) {
                    this.username = username;
                    this.age = age;
                }
            
                public String getUsername() {
                    return username;
                }
            
                public void setUsername(String username) {
                    this.username = username;
                }
            
                public int getAge() {
                    return age;
                }
            
                public void setAge(int age) {
                    this.age = age;
                }
            }
            
            ```

        - JpaMain.java

            ```
            List<MemberDTO> result = em.createQuery("select new jpql.MemberDTO(m.username, m.age) from Member m", MemberDTO.class).getResultList();
            
            MemberDTO memberDTO = result.get(0);
            System.out.println("username = " + memberDTO.getUsername());
            System.out.println("age = " + memberDTO.getAge());
            ```

    - íŒ¨í‚¤ì§€ëª…ì„ í¬í•¨í•œ ì „ì²´ í´ë˜ìŠ¤ ëª… ì…ë ¥
    - ìˆœì„œì™€ íƒ€ì…ì´ ì¼ì¹˜í•˜ëŠ” ìƒì„±ì í•„ìš”

<br>

## í˜ì´ì§•

- JPAëŠ” í˜ì´ì§•ì„ ë‹¤ìŒ ë‘ APIë¡œ ì¶”ìƒí™”
- `setFirstResult(int startPosition)`: ì¡°íšŒ ì‹œì‘ ìœ„ì¹˜(0ë¶€í„° ì‹œì‘)
- `setMaxResult(int maxResult)`: ì¡°íšŒí•  ë°ì´í„° ìˆ˜

> Main

```
for(int i = 0; i < 100; i++){
    Member member = new Member();
    member.setUsername("member" + i);
    member.setAge(i);
    em.persist(member);
}

em.flush();
em.clear();

List<Member> result = em.createQuery("select m from Member m order by m.age desc", Member.class)
     .setFirstResult(0)
     .setMaxResults(10)
     .getResultList();

System.out.println("result.size() = " + result.size());
for (Member member1 : result) {
     System.out.println("member1 = " + member1);
}

tx.commit();
```

- Memberì—ì„œ toStringí•´ì£¼ê¸°

> Member.java

```
@Override
    public String toString() {
        return "Member{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", age=" + age +
                // ", team=" + team +
                '}';
    }
```

- teamì˜ toStringì—ì„œë„ ì–‘ë°©í–¥ìœ¼ë¡œ í˜¸ì¶œë˜ì–´ ìŠ¤íƒì˜¤ë²„í”Œë¡œ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—†ì• ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤

> ì¶œë ¥ ì¿¼ë¦¬ì™€ ê²°ê³¼
```
Hibernate: 
    /* select
        m 
    from
        Member m 
    order by
        m.age desc */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.username 
        from
            Member m1_0 
        order by
            m1_0.age desc 
        offset
            ? rows 
        fetch
            first ? rows only
```
```
result.size() = 10
member1 = Member{id=100, username='member99', age=99}
member1 = Member{id=99, username='member98', age=98}
member1 = Member{id=98, username='member97', age=97}
member1 = Member{id=97, username='member96', age=96}
member1 = Member{id=96, username='member95', age=95}
member1 = Member{id=95, username='member94', age=94}
member1 = Member{id=94, username='member93', age=93}
member1 = Member{id=93, username='member92', age=92}
member1 = Member{id=92, username='member91', age=91}
member1 = Member{id=91, username='member90', age=90}
```

<br>

## ì¡°ì¸

### ë‚´ë¶€ì¡°ì¸

- íŒ€ì´ ì—†ìœ¼ë©´ ë°ì´í„°ê°€ ì•„ì˜ˆ ì•ˆë‚˜ì˜´

```
SELECT m FROM Member m [INNER] JOIN m.team t
```

```
Hibernate: 
    /* select
        m 
    from
        Member m 
    inner join
        m.team t */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.username 
        from
            Member m1_0 
        join
            Team t1_0 
                on t1_0.id=m1_0.TEAM_ID
Hibernate: 
    select
        t1_0.id,
        t1_0.name 
    from
        Team t1_0 
    where
        t1_0.id=?
```

- selectë¬¸ì´ 2ë²ˆ ë‚˜ê°€ëŠ” ì´ìœ ?
    - ë‹¤ëŒ€ì¼ì€ `FetchType.EAGER`ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ â†’ ì¦‰ì‹œ ë¡œë”©
    - ë”°ë¼ì„œ, Member ì—”í‹°í‹°ì—ì„œ `FetchType.LAZY`ë¡œ ì„¤ì •í•´ì¤˜ì•¼ í•œë‹¤

        ```
        @ManyToOne(fetch = FetchType.LAZY)
        @JoinColumn(name="TEAM_ID")
        private Team team;
        ```


### ì™¸ë¶€ì¡°ì¸

- íšŒì›ì€ ìˆê³  íŒ€ì€ ì—†ì–´ë„ ë©¤ë²„ëŠ” ë‚˜ì˜´

```
SELECT m FROM Member m LEFT [OUTER] JOIN m.team t
```

```
Hibernate: 
    /* select
        m 
    from
        Member m 
    left outer join
        m.team t */ select
            m1_0.id,
            m1_0.age,
            m1_0.TEAM_ID,
            m1_0.username 
        from
            Member m1_0
```

### ì„¸íƒ€ì¡°ì¸

- ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” ê²ƒì„ ë¹„êµí•´ë³´ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©

```
select count(m) from Member m, Team t where m.username = t.name
```

### ì¡°ì¸ - ON ì ˆ

- ONì ˆì„ í™œìš©í•œ ì¡°ì¸(JPA 2.1ë¶€í„° ì§€ì›)

> ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§

ì˜ˆ) íšŒì›ê³¼ íŒ€ì„ ì¡°ì¸í•˜ë©´ì„œ, íŒ€ ì´ë¦„ì´ Aì¸ íŒ€ë§Œ ì¡°ì¸

```
// JPQL
SELECT m, t FROM Member m LEFT JOIN m.team t on t.name = 'A'

// SQL
SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.TEAM_ID = t.id and t.name = 'A'
```

> ì—°ê´€ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸(í•˜ì´ë²„ë„¤ì´íŠ¸ 5.1ë¶€í„°)

ì˜ˆ) íšŒì›ì˜ ì´ë¦„ê³¼ íŒ€ì˜ ì´ë¦„ì´ ê°™ì€ ëŒ€ìƒ ì™¸ë¶€ ì¡°ì¸

```
// JPQL
SELECT m, t FROM Member m LEFT JOIN Team t on m.username = t.name

// SQL
SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.username = t.name
```

<br>

## ì„œë¸Œ ì¿¼ë¦¬

- ë‚˜ì´ê°€ í‰ê· ë³´ë‹¤ ë§ì€ íšŒì›

    ```
    select m from Member m where m.age > (select avg(m2.age) from Member m2)
    ```

- í•œ ê±´ì´ë¼ë„ ì£¼ë¬¸í•œ ê³ ê°

    ```
    select m from Member m where (select count(o) from Order o where m = o.member) > 0
    ```


### ì„œë¸Œ ì¿¼ë¦¬ ì§€ì› í•¨ìˆ˜

- [NOT] EXISTS (subquery): ì„œë¸Œì¿¼ë¦¬ì— ê²°ê³¼ê°€ ì¡´ì¬í•˜ë©´ ì°¸
    - {ALL | ANY | SOME} (subquery)
    - ALL ëª¨ë‘ ë§Œì¡±í•˜ë©´ ì°¸
    - ANY, SOME: ê°™ì€ ì˜ë¯¸, ì¡°ê±´ì„ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ì°¸
- [NOT] IN (subquery): ì„œë¸Œì¿¼ë¦¬ì˜ ê²°ê³¼ ì¤‘ í•˜ë‚˜ë¼ë„ ê°™ì€ ê²ƒì´ ìˆìœ¼ë©´ ì°¸

### ì„œë¸Œ ì¿¼ë¦¬ ì˜ˆì œ

- íŒ€A ì†Œì†ì¸ íšŒì›

    ```
    select m from Member m where exists (select t from m.team t where t.name = 'íŒ€A')
    ```

- ì „ì²´ ìƒí’ˆ ê°ê°ì˜ ì¬ê³ ë³´ë‹¤ ì£¼ë¬¸ëŸ‰ì´ ë§ì€ ì£¼ë¬¸ë“¤

    ```
    select o from Order o where o.orderAmount > ALL (select p.stockAmount from Product p)
    ```

- ì–´ë–¤ íŒ€ì´ë“  íŒ€ì— ì†Œì†ëœ íšŒì›

    ```
    select m from Member m where m.team = ANY (select t from Team t)
    ```

### JPA ì„œë¸Œ ì¿¼ë¦¬ í•œê³„

- JPAëŠ” WHERE, HAVING ì ˆì—ì„œë§Œ ì„œë¸Œ ì¿¼ë¦¬ ì‚¬ìš© ê°€ëŠ¥
- SELECTì ˆë„ ê°€ëŠ¥(í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„œ ì§€ì›)

    ```
    select (select avg(m1.age) From Member m1) as avgAge from Member m left join Team t on m.username = t.name
    ```

- FROMì ˆì˜ ì„œë¸Œì¿¼ë¦¬ëŠ” í˜„ì¬ JPQLì—ì„œ ë¶ˆê°€ëŠ¥
  (**í•˜ì´ë²„ë„¤ì´íŠ¸6ë¶€í„°ëŠ” FROMì ˆì˜ ì„œë¸Œ ì¿¼ë¦¬ë¥¼ ì§€ì›í•¨**)

    ```
    select mm.age, mm.username from (select m.age, m.username from Member m) as mm
    ```

    - ì¡°ì¸ìœ¼ë¡œ í’€ ìˆ˜ ìˆìœ¼ë©´ í’€ì–´ì„œ í•´ê²°
    - ì¡°ì¸ìœ¼ë¡œ í•´ê²°ì´ ì•ˆë˜ë©´ ì¿¼ë¦¬ë¥¼ 2ë²ˆ ë‚ ë ¤ì„œ í•´ê²°

<br>

## JPQL íƒ€ì… í‘œí˜„ê³¼ ê¸°íƒ€ì‹

### JPQL íƒ€ì… í‘œí˜„

- ë¬¸ì: â€˜HELLOâ€™, â€˜Sheâ€™â€™sâ€™
- ìˆ«ì: 10L(Long), 10D(Double), 10F(Float)
- Boolean: TRUE, FALSE
- ENUM: jpabook.MemberType.Admin (íŒ¨í‚¤ì§€ëª… í¬í•¨)
- ì—”í‹°í‹° íƒ€ì…: TYPE(m) = Member (ìƒì†ê´€ê³„ì—ì„œ ì‚¬ìš©)

> ì˜ˆì œ

```
Team team = new Team();
            team.setName("teamA");
            em.persist(team);

            Member member = new Member();
            member.setUsername("teamA");
            member.setAge(10);
            member.setType(MemberType.ADMIN);

            // ì—°ê´€ê´€ê³„ ë§Œë“¤ê¸°
            member.changeTeam(team);

            em.persist(member);

            em.flush();
            em.clear();

            String query = "select m.username, 'HELLO', TRUE From Member m " +
                            "where m.type = jpql.MemberType.ADMIN";
            List<Object[]> result = em.createQuery(query).getResultList();

            for (Object[] objects : result) {
                System.out.println("objects[0] = " + objects[0]);
                System.out.println("objects[1] = " + objects[1]);
                System.out.println("objects[2] = " + objects[2]);
            }

            tx.commit();
```

- Boolean íƒ€ì… TRUEëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„ì—†ì´ ì‚¬ìš© ê°€ëŠ¥
- enum í´ë˜ìŠ¤ ì‚¬ìš©ì‹œ íŒ¨í‚¤ì§€ëª…ê¹Œì§€ í•¨ê»˜ ì…ë ¥
    - íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ë©´ íŒ¨í‚¤ì§€ëª… ì…ë ¥ ì•ˆí•´ë„ ë¨

        ```
        String query = "select m.username, 'HELLO', TRUE From Member m " +
                       "where m.type = :userType";
        List<Object[]> result = em.createQuery(query).setParameter("userType", MemberType.ADMIN).getResultList();
        ```

> ì¶œë ¥ê²°ê³¼

```
objects[0] = teamA
objects[1] = HELLO
objects[2] = true
```

### JPQL ê¸°íƒ€

- SQLê³¼ ë¬¸ë²•ì´ ê°™ì€ ì‹
- EXISTS, IN
- AND, OR, NOT
- =, >, â‰¥, <, â‰¤, <>
- BETWEEN, LIKE, IS NULL

<br>

## ì¡°ê±´ì‹(CASE ë“±ë“±)

### ê¸°ë³¸ CASE ì‹

> ì˜ˆì‹œ

```
String query = "select " +
                         "case when m.age <= 10 then 'í•™ìƒìš”ê¸ˆ' " +
                         "     when m.age <= 60 then 'ê²½ë¡œìš”ê¸ˆ' " +
                         "     else 'ì¼ë°˜ìš”ê¸ˆ' " +
                         "end " +
               "from Member m";
List<String> result = em.createQuery(query, String.class).getResultList();

for (String s : result) {
     System.out.println("s = " + s);
}
```

> ì¿¼ë¦¬ë¬¸ê³¼ ì¶œë ¥ê²°ê³¼
>

```
Hiberna te: 
    /* select
        case 
            when m.age <= 10 
                then 'í•™ìƒìš”ê¸ˆ'      
            when m.age <= 60 
                then 'ê²½ë¡œìš”ê¸ˆ'     
            else 'ì¼ë°˜ìš”ê¸ˆ' 
        end 
    from
        Member m */ select
            case 
                when m1_0.age<=10 
                    then 'í•™ìƒìš”ê¸ˆ' 
                when m1_0.age<=60 
                    then 'ê²½ë¡œìš”ê¸ˆ' 
                else 'ì¼ë°˜ìš”ê¸ˆ' 
            end 
        from
            Member m1_0
            
s = í•™ìƒìš”ê¸ˆ
```

### ë‹¨ìˆœ CASE ì‹

> ì˜ˆì‹œ

```
select
			case t.name
					 when 'íŒ€A' then 'ì¸ì„¼í‹°ë¸Œ110%'
					 when 'íŒ€B' then 'ì¸ì„¼í‹°ë¸Œ120%'
					 else 'ì¸ì„¼í‹°ë¸Œ105%'
			end
from Team t
```

### COALESCE

- í•˜ë‚˜ì”© ì¡°íšŒí•´ì„œ nullì´ ì•„ë‹ˆë©´ ë°˜í™˜

```
select coalesce(m.username, 'ì´ë¦„ ì—†ëŠ” íšŒì›') as username from Member m
```

> ì¶œë ¥ê²°ê³¼

```
s = ì´ë¦„ ì—†ëŠ” íšŒì›
```

- usernameì´ nullì´ë¯€ë¡œ â€˜ì´ë¦„ ì—†ëŠ” íšŒì›â€™ ì´ë¼ëŠ” ë¬¸ìê°€ ì¶œë ¥

### NULLIF

- ë‘ ê°’ì´ ê°™ìœ¼ë©´ null ë°˜í™˜, ë‹¤ë¥´ë©´ ì²«ë²ˆì§¸ ê°’ ë°˜í™˜

```
member.setUsername("ê´€ë¦¬ì");

select nullif(m.username, 'ê´€ë¦¬ì') as username from Member m
```

> ì¶œë ¥ê²°ê³¼

```
s = null
```

- ë‘ ê°’ì´ ì¼ì¹˜í•˜ë¯€ë¡œ null ë°˜í™˜

<br>

## JPQL í•¨ìˆ˜

### JPQL ê¸°ë³¸ í•¨ìˆ˜

- CONCAT

    ```
    select concat('a', 'b') from Member m
    
    select 'a' || 'b' from Member m
    ```

- SUBSTRING

    ```
    select substring(m.username, 2, 3) from Member m
    ```

- TRIM
    - ê³µë°± ì œê±°
- LOWER, UPPER
    - ëŒ€ì†Œë¬¸ì êµ¬ë¶„
- LENGTH
    - ë¬¸ìì˜ ê¸¸ì´
- LOCATE

  > ì˜ˆì‹œ

    ```
    select locate('de', 'abcdef') from Member m
    ```

    - abcdef ë¬¸ìì—ì„œ deê°€ ìœ„ì¹˜í•œ ë²ˆí˜¸ë¥¼ ì•Œë ¤ì¤Œ

  > ì¶œë ¥ê²°ê³¼

    ```
    s = 4
    ```

- ABS, SQRT, MOD
- SIZE
    - ì»¬ë™ì…˜ í¬ê¸°ë¥¼ ì•Œë ¤ì¤Œ

  > ì˜ˆì‹œ

    ```
    select size(t.members) from Team t
    ```

- INDEX
    - `@OrderColumn` ì„ ì“¸ ë•Œ ì‚¬ìš©(ë¦¬ìŠ¤íŠ¸ì˜ ê°’ íƒ€ì…ì¼ ë•Œ ê°’ íƒ€ì… ì»¬ë ‰ì…˜ì—ì„œ ì˜µì…˜ì„ ì¤˜ì„œ ì‚¬ìš©)

  > ì˜ˆì‹œ

    ```
    @OrderColumn
    String query = "select index(t.members) from Team t";
    List<Integer> result = em.createQuery(query, Integer.class).getResultList();
    ```

    - ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

### ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í˜¸ì¶œ

- í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì‚¬ìš©ì „ ë°©ì–¸ì— ì¶”ê°€í•´ì•¼ í•œë‹¤.
    - ì‚¬ìš©í•˜ëŠ” DBë°©ì–¸ì„ ìƒì†ë°›ê³ , ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ë¥¼ ë“±ë¡í•œë‹¤.

âš ï¸ Hibernate versionìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ ë°œìƒ

[ì°¸ê³ ](https://velog.io/@no-int/JPA.-JPQL)

ğŸ”¸ Hibernate version 6 ì´í•˜(ê°•ì˜)

```
public class MyH2Dialect extends H2Dialect{
        public MyH2Dialect() {
        registerFunction("group_concat", new StandardSQLFunction("group_concat", StandardBasicTypes.STRING));
    }
}

```

- í•˜ì´ë²„ë„¤ì´íŠ¸ ë²„ì „ 6ì´ìƒìœ¼ë¡œ ì‹¤ìŠµì„ ì§„í–‰í•˜ì˜€ëŠ”ë° `registerFunction` ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì—ˆìŒ

ğŸ”¸ Hibernate version 6ì´ìƒ ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ ì„¤ì •

> resources > META-INF > services ë””ë ‰í† ë¦¬ ìƒì„± í›„, `org.hibernate.boot.model.FunctionContributor` íŒŒì¼ ìƒì„±(íŒŒì¼ ì´ë¦„ì„!)

<img src="https://github.com/iieunji023/jpql-ex/blob/main/images/jpql_ì‚¬ìš©ìí•¨ìˆ˜ì„¤ì •.png" width="250">

<details>
      <summary>org.hibernate.boot.model.FunctionContributor íŒŒì¼</summary>

```
dialect.MyH2Dialect
```

- íŒ¨í‚¤ì§€ê²½ë¡œ.í´ë˜ìŠ¤ëª…

</details>

> main > java > dialect > MyH2Dialect.java í´ë˜ìŠ¤ ìƒì„± í›„, ì‚¬ìš©ì ì •ì˜í•¨ìˆ˜ ì‘ì„±

<details>
      <summary>MyH2Dialect.java</summary>

```
package dialect;

import org.hibernate.boot.model.FunctionContributor;
import org.hibernate.dialect.H2Dialect;
import org.hibernate.dialect.function.StandardSQLFunction;
import org.hibernate.type.StandardBasicTypes;
import org.hibernate.boot.model.FunctionContributions;

    public class MyH2Dialect extends H2Dialect implements FunctionContributor {
        public MyH2Dialect() {
            super();
        }

        @Override
        public void contributeFunctions(FunctionContributions functionContributions) {
            functionContributions.getFunctionRegistry()
                    .register("group_concat", new StandardSQLFunction("group_concat", StandardBasicTypes.STRING));
        }
}
```

- H2Dialectë¥¼ ìƒì† ë°›ì€ í›„ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ ì¤˜ì•¼ í•¨!
- ìƒì† ë°›ì§€ ì•Šê³  ì‹¤í–‰í•˜ë‹ˆ `ClassCastException` ë°œìƒ
  - `MyH2Dialect` í´ë˜ìŠ¤ê°€ `Dialect`ë¥¼ ìƒì†í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œ

</details>

> resource > META-INF > persistence,xml

<details>
      <summary>persistence.xml</summary>

```
<property name="hibernate.dialect" value="dialect.MyH2Dialect"/>
```

- MyH2Dialectì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì • ë³€ê²½

</details>

> main-  ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ ì‹¤í–‰

```
select function('group_concat', m.username) from Member m

== 

select group_concat(m.username) from Member m
```

> ì¶œë ¥ê²°ê³¼

```
s = ê´€ë¦¬ì1,ê´€ë¦¬ì2
```
